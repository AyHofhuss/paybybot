# .github/workflows/parking_payment.yml

name: Paiement Hebdo PayByPhone

on:
  schedule:
    # Tous les jours √† 07:00 UTC (ajustez l'heure selon votre besoin)
    - cron: '0 7 * * *'
  # Permet de lancer manuellement le workflow depuis l'interface GitHub
  workflow_dispatch:

jobs:
  pay_parking:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è Checkout du code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: üì¶ Installer PayByBot3
      run: pip install paybybot3 apprise # Installation d'Apprise est n√©cessaire pour les notifications

    - name: üîí Injection S√©curis√©e des Secrets dans le YAML
      # Injecte les secrets dans le fichier paybybot3.yml √† la racine du d√©p√¥t
      run: |
        # Injections : Les noms des secrets sont tir√©s de votre coffre-fort (PBP_PLATE, PAYBYPHONE_LOGIN, etc.)
        
        # 1. Pr√©paration de l'URL de notification (Utilise le mail personnel pour l'envoi et la r√©ception)
        # Note: smtp.gmail.com:587 est l'h√¥te par d√©faut pour Gmail.
        NOTIF_URL="smtps://${{ secrets.NOTIF_USER }}:${{ secrets.NOTIF_PASS }}@smtp.gmail.com:587?to=${{ secrets.NOTIF_USER }}&name=PayByBot3"

        # 2. Injection des Placeholders dans le fichier paybybot3.yml
        # Injection Plaque
        sed -i "s|PLACEHOLDER_PLATE|${{ secrets.PBP_PLATE }}|g" paybybot3.yml
        # Injection Login (votre secret PAYBYPHONE_LOGIN)
        sed -i "s|PLACEHOLDER_USER|${{ secrets.PAYBYPHONE_LOGIN }}|g" paybybot3.yml
        # Injection Mot de passe (votre secret PAYBYPHONE_PASS)
        sed -i "s|PLACEHOLDER_PASS|${{ secrets.PAYBYPHONE_PASS }}|g" paybybot3.yml
        # Injection ID de Paiement
        sed -i "s|PLACEHOLDER_PAYMENT_ID|${{ secrets.PBP_PAYMENT_ID }}|g" paybybot3.yml
        # Injection de la notification
        sed -i "s|PLACEHOLDER_NOTIF_URL|$NOTIF_URL|g" paybybot3.yml
        
        echo "Le fichier de configuration a √©t√© mis √† jour de mani√®re s√©curis√©e."

    - name: üìÅ D√©placer le fichier de configuration
      # Copie le fichier modifi√© vers l'emplacement par d√©faut o√π paybybot3 le cherche
      run: |
        mkdir -p ~/.config # Cr√©e le dossier .config
        cp paybybot3.yml ~/.config/paybybot3.yml # Copie le fichier dans le dossier utilisateur
        
    - name: üÖøÔ∏è Ex√©cuter le Paiement Hebdomadaire
      # On passe le login/pass dans l'environnement (variable PAYBYPHONE_USER requise par le bot)
      env:
        PAYBYPHONE_USER: ${{ secrets.PAYBYPHONE_LOGIN }} 
        PAYBYPHONE_PASS: ${{ secrets.PAYBYPHONE_PASS }}
      run: |
        # Lancement de la commande 'pay'
        python -m paybybot3 pay ${{ secrets.CONFIG_ACCOUNT_NAME }} \
          --location ${{ secrets.PBP_LOCATION }} \
          --rate ${{ secrets.PBP_RATE }} \
          --duration 6 \
          --unit Days
        
        echo "La t√¢che de paiement est termin√©e. V√©rifiez le log ci-dessus."
