# Fichier : .github/workflows/parking_payment.yml

name: Paiement Hebdomadaire & Planification

on:
  schedule:
    # Tous les jours √† 6h UCT soit 7/8h √† Paris
    - cron: '0 6 * * *' 
  workflow_dispatch: # Permet de lancer manuellement pour les tests

jobs:
  pay_parking:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è Checkout du code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: üì¶ Installer PayByBot3, et les packages
      run: |
        pip install pyyaml paybybot3
        # Installation de l'outil GitHub CLI, n√©cessaire pour la planification (dispatch)
        sudo apt-get update && sudo apt-get install -y gh

    - name: üöÄ Ex√©cuter la Logique de Paiement et Planification (Python)
      # D√©finition des variables d'environnement n√©cessaires au script Python
      env:
        CONFIG_FILE: ./paybybot3.yml
        CONFIG_ACCOUNT_NAME: ${{ secrets.CONFIG_ACCOUNT_NAME }}
        PBP_LOCATION: ${{ secrets.PBP_LOCATION }}
        PBP_RATE: ${{ secrets.PBP_RATE }}
        PBP_DURATION: 6
        PBP_UNIT: Days
        
        # Secrets pour l'injection via inject_secrets()
        PBP_PLATE: ${{ secrets.PBP_PLATE }}
        PAYBYPHONE_LOGIN: ${{ secrets.PAYBYPHONE_LOGIN }} 
        PAYBYPHONE_PASS: ${{ secrets.PAYBYPHONE_PASS }}
        PBP_PAYMENT_ID: ${{ secrets.PBP_PAYMENT_ID }}
        
        # Le PAT GitHub pour la planification des jobs
        GH_PAT: ${{ secrets.GH_PAT }} 
        
      run: python parking_scheduler.py
