# .github/workflows/parking_payment.yml

name: Paiement Hebdo PayByPhone

on:
  schedule:
    # Tous les jours √† 07:00 UTC (ajustez l'heure selon votre besoin)
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  pay_parking:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è Checkout du code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: üì¶ Installer PayByBot3
      run: pip install paybybot3

    - name: üîí Injection S√©curis√©e des Secrets dans le YAML
      run: |
        # 1. Injection des Placeholders dans le fichier paybybot3.yml
        
        # Injection Plaque
        sed -i "s|PLACEHOLDER_PLATE|${{ secrets.PBP_PLATE }}|g" paybybot3.yml
        # Injection Login
        sed -i "s|PLACEHOLDER_USER|${{ secrets.PAYBYPHONE_LOGIN }}|g" paybybot3.yml
        # Injection Mot de passe
        sed -i "s|PLACEHOLDER_PASS|${{ secrets.PAYBYPHONE_PASS }}|g" paybybot3.yml
        # Injection ID de Paiement
        sed -i "s|PLACEHOLDER_PAYMENT_ID|${{ secrets.PBP_PAYMENT_ID }}|g" paybybot3.yml
        
        echo "Le fichier de configuration a √©t√© mis √† jour de mani√®re s√©curis√©e."

    - name: üÖøÔ∏è Ex√©cuter le Paiement Hebdomadaire
      # Passer les secrets en tant que variables d'environnement (PAYBYPHONE_USER/PASS est le format requis par le code du bot)
      env:
        # Le secret PAYBYPHONE_LOGIN est inject√© dans la variable d'environnement attendue PAYBYPHONE_USER
        PAYBYPHONE_USER: ${{ secrets.PAYBYPHONE_LOGIN }} 
        PAYBYPHONE_PASS: ${{ secrets.PAYBYPHONE_PASS }}
      run: |
        # Lancement de la commande 'pay'
        python -m paybybot3 pay ${{ secrets.CONFIG_ACCOUNT_NAME }} \
          --location ${{ secrets.PBP_LOCATION }} \
          --rate ${{ secrets.PBP_RATE }} \
          --duration 6 \
          --unit Days
        
        echo "La t√¢che de paiement est termin√©e. V√©rifiez le log ci-dessus."
