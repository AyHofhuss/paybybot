# .github/workflows/parking_payment.yml

name: Paiement Hebdo PayByPhone

on:
  # D√©clenche l'action tous les jours √† 8h00 (heure de Paris/UTC+1)
  schedule:
    # L'heure est en UTC. 8h00 CET/CEST √©quivaut √† 7h00 ou 6h00 UTC.
    # Pour √™tre pr√©cis, vous devez ajuster en fonction du passage heure d'√©t√©/hiver.
    # Ici, 06:00 UTC (8h00 heure d'√©t√© ou 7h00 heure d'hiver √† Paris)
    - cron: '0 7 * * *'
  # Permet de lancer manuellement le workflow depuis l'interface GitHub
  workflow_dispatch:

jobs:
  pay_parking:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è Checkout du code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Configurer Python et PayByBot3
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
      run: pip install paybybot3

    - name: üîí Injection S√©curis√©e des Secrets dans le YAML
      # Cette √©tape modifie le fichier paybybot3.yml juste avant l'ex√©cution
      run: |
        # IMPORTANT: Nous utilisons les variables d'environnement pour injecter les secrets
        # pour √©viter qu'ils n'apparaissent dans les logs (le 'echo' est √©vit√©)
        
        # 1. Injection de la plaque, login, password et Payment ID dans le fichier
        sed -i "s|PLACEHOLDER_PLATE|${{ secrets.PBP_PLATE }}|g" paybybot3.yml
        sed -i "s|PLACEHOLDER_USER|${{ secrets.PAYBYPHONE_LOGIN }}|g" paybybot3.yml
        sed -i "s|PLACEHOLDER_PASS|${{ secrets.PAYBYPHONE_PASS }}|g" paybybot3.yml
        sed -i "s|PLACEHOLDER_PAYMENT_ID|${{ secrets.PBP_PAYMENT_ID }}|g" paybybot3.yml
        
        echo "Le fichier de configuration a √©t√© mis √† jour de mani√®re s√©curis√©e."

    - name: üÖøÔ∏è Ex√©cuter le Paiement Quotidien
      # Les secrets PBP_USER/PBP_PASS ne sont plus n√©cessaires ici car ils ont √©t√© inject√©s dans le YAML,
      # mais nous les passons pour la double v√©rification du code paybybot3, juste au cas o√π.
      env:
        PAYBYPHONE_USER: ${{ secrets.PAYBYPHONE_LOGIN }}
        PAYBYPHONE_PASS: ${{ secrets.PAYBYPHONE_PASS }}
      run: |
        # Lancement de la commande 'pay'
        # Le nom du compte est un secret, ainsi que la location et le rate
        python -m paybybot3 pay ${{ secrets.CONFIG_ACCOUNT_NAME }} \
          --location ${{ secrets.PBP_LOCATION }} \
          --rate ${{ secrets.PBP_RATE }} \
          --duration 6 \
          --unit Days
        
        echo "La t√¢che de paiement est termin√©e. V√©rifiez le log ci-dessus."
