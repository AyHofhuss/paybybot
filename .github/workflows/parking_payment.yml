# .github/workflows/parking_payment.yml

name: Paiement Hebdo PayByPhone

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  pay_parking:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è Checkout du code
      uses: actions/checkout@v4

    # --- √âTAPE 1 : Configuration Python (uses) ---
    - name: üõ†Ô∏è Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    # --- √âTAPE 2 : Installation des d√©pendances (run) ---
    - name: üì¶ Installer PayByBot3 et Apprise
      run: pip install paybybot3 apprise

  # --- DELETE
    - name: üìß TEST ISOL√â - Envoi d un E-mail de D√©bogage
      run: |
        # Configuration de l'URL du SERVEUR avec le port 465 (Alternative s√©curis√©e)
        SERVER_URL="mailtos://${{ secrets.NOTIF_USER }}:${{ secrets.NOTIF_PASS }}@smtp.gmail.com:465"
        
        # Le destinataire doit √™tre pass√© s√©par√©ment pour √©viter l'erreur d'interpr√©tation
        DESTINATION_URL="mailto:${{ secrets.NOTIF_USER }}"
        
        echo "Serveur utilis√© : $SERVER_URL"
        
        # Ex√©cution d'Apprise en mode DEBUG (-vv) pour obtenir des logs d√©taill√©s
        apprise -vv -b "Ceci est un test de connexion depuis GitHub Actions via le port 465." \
          --title "Test SMTP 465" \
          "$SERVER_URL" \
          "$DESTINATION_URL"
  # --- DELETE


    - name: üîí Injection S√©curis√©e des Secrets dans le YAML (y compris les notifications)
      run: |
        # 1. Pr√©paration de l'URL de notification (Utilise le mail personnel pour l'envoi et la r√©ception)
        NOTIF_URL="mailtos://${{ secrets.NOTIF_USER }}:${{ secrets.NOTIF_PASS }}@smtp.gmail.com:587?to=${{ secrets.NOTIF_USER }}&name=PayByBot3"

        # 2. Injection des Placeholders dans le fichier paybybot3.yml
        # Injection Plaque
        sed -i "s|PLACEHOLDER_PLATE|${{ secrets.PBP_PLATE }}|g" paybybot3.yml
        # Injection Login (votre secret PAYBYPHONE_LOGIN)
        sed -i "s|PLACEHOLDER_USER|${{ secrets.PAYBYPHONE_LOGIN }}|g" paybybot3.yml
        # Injection Mot de passe (votre secret PAYBYPHONE_PASS)
        sed -i "s|PLACEHOLDER_PASS|${{ secrets.PAYBYPHONE_PASS }}|g" paybybot3.yml
        # Injection ID de Paiement
        sed -i "s|PLACEHOLDER_PAYMENT_ID|${{ secrets.PBP_PAYMENT_ID }}|g" paybybot3.yml
        # Injection de la notification
        sed -i "s|PLACEHOLDER_NOTIF_URL|$NOTIF_URL|g" paybybot3.yml
        
        echo "Le fichier de configuration a √©t√© mis √† jour de mani√®re s√©curis√©e."

    - name: üÖøÔ∏è Ex√©cuter le Paiement Hebdomadaire
      env:
        PAYBYPHONE_USER: ${{ secrets.PAYBYPHONE_LOGIN }} 
        PAYBYPHONE_PASS: ${{ secrets.PAYBYPHONE_PASS }}
      run: |
        python -m paybybot3 pay ${{ secrets.CONFIG_ACCOUNT_NAME }} \
          --config ./paybybot3.yml \
          --location ${{ secrets.PBP_LOCATION }} \
          --rate ${{ secrets.PBP_RATE }} \
          --duration 6 \
          --unit Days
        
        echo "La t√¢che de paiement est termin√©e. V√©rifiez le log ci-dessus."
