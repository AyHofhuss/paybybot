# Fichier : .github/workflows/parking_payment_dispatch.yml

name: Paiement Ponctuel (Relance Planifi√©e)

on:
  # Ce workflow s'ex√©cute UNIQUEMENT via l'API (d√©clench√© par le job principal)
  workflow_dispatch:
    inputs:
      # L'heure exacte √† laquelle nous voulons que le job commence (pr√©cision maximale)
      launch_time:
        description: 'Heure planifi√©e de l''ex√©cution (ISO 8601 UTC)'
        required: true
      # Le nom du compte √† payer, transmis par le job principal
      target_account:
        description: 'Nom du compte PayByBot3 √† payer'
        required: true

jobs:
  relance_paiement:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
      
      - name: üõ†Ô∏è Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      # 1. Attendre l'heure planifi√©e
      - name: ‚è≥ Attendre l'Heure de Lancement Planifi√©e
        run: |
          # Convertit l'heure cible (pass√©e en input) en timestamp UNIX (secondes)
          PLANNED_TIME=$(date -u -d "${{ github.event.inputs.launch_time }}" +%s)
          # R√©cup√®re l'heure actuelle du runner
          CURRENT_TIME=$(date -u +%s)
          # Calcule le temps d'attente restant
          WAIT_SECONDS=$((PLANNED_TIME - CURRENT_TIME))
          
          if [ "$WAIT_SECONDS" -gt 0 ]; then
            echo "Attente de $WAIT_SECONDS secondes avant la relance du paiement pour atteindre l'heure cible."
            sleep $WAIT_SECONDS
          fi

      # 2. Installer
      - name: üì¶ Installer D√©pendances
        run: pip install -r requirements.txt

      # 3. Injecter les secrets
      - name: üîí Injecter les Secrets (Python)
        env:
          CONFIG_FILE: ./paybybot3.yml
          CONFIG_ACCOUNT_NAME: ${{ github.event.inputs.target_account }} # Utilise l'input du dispatch
          # Secrets pour l'injection via inject_secrets()
          PBP_PLATE: ${{ secrets.PBP_PLATE }}
          PAYBYPHONE_LOGIN: ${{ secrets.PAYBYPHONE_LOGIN }} 
          PAYBYPHONE_PASS: ${{ secrets.PAYBYPHONE_PASS }}
          PBP_PAYMENT_ID: ${{ secrets.PBP_PAYMENT_ID }}
          # NOTE: Le script Python inject_secrets ne fait rien de ces variables, mais elles doivent √™tre l√† pour √©viter une erreur
          NOTIF_USER: DUMMY_USER 
          NOTIF_PASS: DUMMY_PASS

        run: python parking_scheduler.py

      # 4. Ex√©cuter le Paiement Final (La session est maintenant expir√©e)
      - name: üÖøÔ∏è Ex√©cuter le Paiement Final
        env:
          CONFIG_ACCOUNT_NAME: ${{ github.event.inputs.target_account }}
          CONFIG_FILE: ./paybybot3.yml
          PBP_LOCATION: ${{ secrets.PBP_LOCATION }}
          PBP_RATE: ${{ secrets.PBP_RATE }}
          PBP_DURATION: 6
          PBP_UNIT: Days

        run: |
          # Nous n'avons pas besoin de toute la logique de "execute_payment_and_analyze" ici, 
          # car on sait que l'heure d'expiration est atteinte. On lance le paiement directement.
          python -m paybybot3 pay ${{ env.CONFIG_ACCOUNT_NAME }} \
            --config ./paybybot3.yml \
            --location ${{ env.PBP_LOCATION }} \
            --rate ${{ env.PBP_RATE }} \
            --duration 6 \
            --unit Days
          
          echo "Paiement ponctuel termin√©."
